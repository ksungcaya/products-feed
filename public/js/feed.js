!function(){var t={init:function(){return this.feedData={url:$("a#feed-url").text(),page:1},this.feedContainer=$(".products__feed"),this.feedRequest={xhr:null,done:!1},this.paginationInitialized=!1,this.loader=$(".loader"),this.error=null,this.productModal=$("[data-remodal-id=product-modal]"),this.productModalText=this.productModal.find(".modal__text"),this.productModalBody=this.productModal.find(".modal__body"),this.bindEvents(),this},bindEvents:function(){$(window).bind("beforeunload",$.proxy(function(){return this.feedRequest.done?void 0:"Feed is still processing, do you really want to leave the page?"},this))},process:function(){this.toggleLoading(!0),this.feedRequest.done=!1,this.feedRequest.xhr=$.post("/products/feed/process",this.feedData,$.proxy(this.processCallback,this))},processCallback:function(t){this.feedData;return this.toggleLoading(!1),t.error?(this.feedRequest.done=!0,this.showError(t.error.message)):this.feedDirectoryNotSet()?(this.feedData.feed_directory=t.feed_directory,this.process(),this.getFeedSet(this.onFirstPageLoad)):void(this.feedRequest.done=!0)},getFeedSet:function(t){var e={feed_directory:this.feedData.feed_directory,page:this.feedData.page};this.toggleLoading(!0),$.post("/products/feed/display",e,$.proxy(t,this))},onFirstPageLoad:function(t){var e=this.feedRequest.done,o=t.products;return this.toggleLoading(!1),e&&!o?this.showError("No feed available from this url."):e||o?(this.createProducts(o),this.initializePagination(),void this.bindProductEvents()):this.getFeedSet(this.onFirstPageLoad)},createProducts:function(t){for(var e="",o="",r=4,i=0,d=function(t){return'<div class="row">'+t+"</div>\n"},a=0,s=t.length;s>a;a++)o+=this.productHtml(t[a]),i++,i===r&&(e+=d(o),o="",i=0);e+=d(o),this.feedContainer.append(e)},productHtml:function(t){var e=this.extractCategories(t.categories),o='<div class="col-sm-6 col-xs-12 col-md-3">\n    <div class="product" data-set="'+this.feedData.page+'" data-id="'+t.productId+'">\n        <a href="'+t.productUrl+'" class="product__link" target="__blank" title="'+t.name+'">\n            <img src="'+t.imageUrl+'" alt="'+t.name+'" class="product__image">\n        </a>\n        <div class="product__meta">\n           <a href="'+t.productUrl+'" class="product__name" target="__blank" title="'+t.name+'">\n               '+t.name+'\n           </a>\n           <div class="product__price">\n               <span class="product__price__value">Price: '+t.price+'</span>\n               <span class="product__price__currency">'+t.currency+'</span>\n           </div>\n           <span class="product__categories" title="Categories: '+e+'">Categories: '+e+"</span>\n      </div>\n   </div>\n</div>\n";return o},extractCategories:function(t){return t?t.join(", "):"N/A"},initializePagination:function(){this.paginationInitialized||(this.loadMoreButton=$("<button/>",{text:"Load more...","class":"load-more-btn btn btn-default"}),this.loadMoreButton.initialText=this.loadMoreButton.text(),this.loader.after(this.loadMoreButton),this.loadMoreButton.on("click",$.proxy(this.loadMoreClick,this)))},loadMoreClick:function(){this.feedData.page++,this.loadMoreButton.text("Loading...").prop("disabled",!0),this.getFeedSet(this.onLoadMore)},onLoadMore:function(t){var e=this.loadMoreButton;return this.toggleLoading(!1),!t.products&&this.feedRequest.done?e.text("No more products to load.").prop("disabled",!0).unbind("click"):t.products||this.feedRequest.done?(e.text(e.initialText).prop("disabled",!1),void this.createProducts(t.products)):(this.feedData.page++,this.getFeedSet(this.onLoadMore))},bindProductEvents:function(){var t=this;params={feed_directory:this.feedData.feed_directory},this.feedContainer.on("click",".product",function(e){e.preventDefault(),t.productModalBody.empty(),t.productModalText.text("Fetching product..."),t.getProductModal().open(),params.page=$(this).data("set")||t.feedData.page,params.product_id=$(this).data("id"),$.post("/products/feed/display/product",params,$.proxy(t.onProductFetch,t))})},onProductFetch:function(t){return t.error?this.productModalText.html('<span class="feed__error">'+t.error.message+"</span>"):(this.productModalText.empty(),this.productModalBody.html(this.productModalHtml(t)))},getProductModal:function(){return this.productModal.remodal()},productModalHtml:function(t){return'<div class="row">    <div class="col-sm-4 col-xs-12">\n        <a href="" target="__blank">\n            <img src="'+t.imageUrl+'" class="product__modal__image">\n        </a>\n        <div class="product__modal__meta">\n            <div>\n                <span>Price: '+t.price+"</span>\n                <span>"+t.currency+'</span>\n            </div>\n            <span class="product__modal__meta">Categories: '+this.extractCategories(t.categories)+'</span>\n        </div>\n    </div>\n    <div class="col-sm-8 col-xs-12">\n        <a href="'+t.productUrl+'" class="product__modal__name" target="__blank">'+t.name+'</a>\n        <div class="product__modal__description">'+(this.nl2br(t.description)||"No description available")+"</div>\n    </div>\n</div>"},feedDirectoryNotSet:function(){return!this.feedData.feed_directory},showError:function(t){var e=this.error;e||(e=this.error=$("<span/>",{"class":"feed__error"}),this.feedContainer.append(e)),e.hide().text(t).fadeIn(100)},hideError:function(){this.error&&this.error.fadeOut()},toggleLoading:function(t){return t?this.loader.show():void this.loader.fadeOut(1e3)},nl2br:function(t,e){var o=e||"undefined"==typeof e?"<br />":"<br>";return(t+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+o+"$2")}};t.init().process(),window.ProductsFeed=t}();